[Home](../README.md)
# 마칭 큐브 공부 노트 (2021.11.12)

참고한 책들:
* [Computer Graphics Principles Practice](https://en.wikipedia.org/wiki/Computer_Graphics:_Principles_and_Practice)
* [Real-Time Rendering](https://www.realtimerendering.com/)

## 마칭 큐브란?

### 명시적 곡면과 암시적 곡면<sup>[1](#footnote_1)</sup>

우선 **명시적 곡면**과 **[암시적 곡면](https://en.wikipedia.org/wiki/Implicit_surface)**의 차이를 이해해야 한다. 명시적 곡면이란 우리가 OpenGL이나 DirectX에 직접 정점 자료와 색인 자료를 넘겨주듯이 일일이 공간에 이미 정점과 모서리가 주어진 곡면을 의미한다. 암시적 곡면이란 고등학교 기하와 벡터, 혹은 대학교 선형대수나 그래픽스 수업에서 자주 다루었던 F(x, y, z) = 0 형태의 함수를 의미한다. x + 2y - 3z + 1 = 0라는 식이 3차원 평면을 의미함은 그 누구라도 알 수 있다. 이게 우리 눈에는 좀 더 익고 보기 편하더라도, 이걸 결국 정점과 색인 자료로, 즉 명시적으로 표현해서 렌더링을 해줘야한다.

## 다각형 메시로의 변형<sup>[2](#footnote_2)</sup>

암시적 곡면을 명시적 곡면으로 변환하는 방법을 이해하려면 말이 아니라 그림으로 이해해야한다. 우선 공간을 격자로 나눈다고 상상해보자. 그러면 격자에 의해 이 공간이 정육면체 그리드로 나뉠 것이다. 각 그리드엔 여덟 개의 꼭짓점이 있을 것이고, 이 꼭짓점을 암시적 곡면의 입력변수로 줄 수 있을 것이다. 그 결과가 만약 0과 *같다면*, 그 점은 곡면 위의 점이다. 만약 0보다 *크다면* 곡면 밖의 점이다. 만약 0보다 *작다면* 곡면 안의 점이다. 즉, 최소한 그리드의 한 꼭짓점의 값이 0보다 작다면, 적어도 한 메시가 이 그리드를 통과한다는 의미이다. 이것이 마칭 큐브의 핵심 개념이다.

![525px-MarchingCubes](https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/MarchingCubes.svg/525px-MarchingCubes.svg.png)

위의 그림이 그리드 꼭짓점이 가질 수 있는 모든 가능한 경우이다. 하나 하나 논의하도록 하자. 설명의 편의를 위해, 이 그리드의 크기가 1 × 1 × 1이고, 각 꼭짓점은 각각 (0, 0, 0), (1, 0, 0), (1, 1, 0), (0, 1, 0), (0, 0, 1), (1, 0, 1), (1, 1, 1), (0, 1, 1)의 좌표를 갖는다고 가정하자. 여기서 메시란 삼각형 메시를 의미하는 것이다:

1. 모든 정점이 곡면 밖에 있으므로 그리드 내에 메시가 존재하지 않는다.
2. 한 정점 (1, 0, 0) 만이 곡면 안에 있으므로 그 정점을 지나는 모든 모서리를 지나는 메시가 하나 생긴다.
3. 두 인접한 정점이 곡면 안에 있으므로, 이 정점을 지나는 모든 모서리 중 인접한 정점으로 정의된 모서리를 제외한 모서리를 지나는 메시가 생긴다.
4. 두 인접하지 않은 정점이 곡면 안에 있으므로, 이 정점을 지나는 모든 모서리를 지나는 메시가 생긴다.
5. 세 인접한 정점이 곡면 안에 있으므로, 이 세 정점 간에 생긴 모서리를 제외한, 이 정점을 하나만 포함하는 모든 모서리를 지나는 메시가 생긴다.
6. ...

기본 개념을 설명하기 위해 우선 정점의 값이 0이 되는 경우를 제외했다. 또한 14번째 그림처럼 메시가 여러 방법으로 존재할 수 있는 그리드에 대해서도 언급하지 않았다.

위의 과정이 종료되면 위상적으로는 유효한 isocurve를 갖게 됨. 이제 각 그리드 모서리의 어디를 메시가 지나야하는지를 정해주면 됨 (지금은 중점이라고 대충 해놨음).

이 isosurface로부터 얻을 수 있는 속성들:
* 각 isocurve의 정점은 해당 모서리를 정의하는 두 그리드 정점을 통해 명명해줄 수 있음. 만약 isocurve 정점이 그리드 정점 (1, 0, 0)과 (1, 1, 0)이 이루는 모서리 위에 있다면, 이 정점의 이름을 각 그리드 정점의 x, y 성분만 따와서 (1, 0, 1, 1)로 부를 수 있다.
* 각 그리드에 대해 다음을 수행한다:
    * isocurve 정점을 구한다.
    * 만약 이 정점은 새롭게 추가된 정점이라면, 정점 테이블에 이름으로 매핑해준다. 이미 테이블에 있는 거면 아무 것도 하지 않는다.
    * 새 정점마다 각 그리드 정점의 암시적 값에 따라 정점의 위치를 결정한다.
    * +와 -의 패턴에 따라 모서리를 추가해주고, 모서리 테이블에 추가한다.
* 결과적으로 얻은 isocurve의 집합의 모든 정점은 정확히 두 모서리가 공유하게 될 것이다. 즉, isocurve는 전부 단순 폐곡선 혹은 연속선이다.

만약 그리드 정점의 값이 0이라면, 일단 0보다는 살짝 큰 값을 줘서 알고리듬을 돌려준 다음(그럼 여러 정점이 생길 것이다), 마지막에 가서 하나의 정점으로 통일해준다.

하나 이상의 그리드 정점의 값이 0이라면, 위와 동일하게 값 약간 바꿔주고 마지막에 복구해준다.

### 마칭 큐브

1. 모든 그리드 정점이 0이 아니라고 가정
    * 값이 0이라면 임의의 작은 수를 부여
2. isosurface를 구하고, 그리드 정점에 따라 올바른 위치로 옮김

그리드의 꼭짓점 여덟 개의 패턴을 8 비트 이진수로 표현해줄 수 있다. 이를 룩업 테이블로 만들어줄 수 있다. 나중에 정점들의 실제 위치는 보간해주면 되니깐.

그리드 모서리는 isocurve 정점이 있을 수도, 하나 있을 수도 있다. 만약 후자의 경우라면, 해당 모서리에 인접한 다른 그리드와 정점을 공유하는 것이다. 하지만, 정점을 공유한다고 해서 서로 마주보는 면이 동일하게 모서리를 갖고 있다는 건 아닐 수도 있다. 서로 일관되지 않으면 그리드 안에 모서리가 존재한다는 모순적인 상황이 발생하므로, 일관성을 맞춰주기 위해 모든 256 가지의 경우에 대응하는 256 가지 모델을 사용해야한다.

---

<div id="footnote_1">
<p>1. 이 문단은 김도엽 저자의  <a href="https://fluidenginedevelopment.org/">&lt;The Fluid Engine Development></a>를 참고하여 작성함</p>
</div>
<div id="footnote_2">
<p>2. 이 문단은 James D. Foley, Andries van Dam, Steven K. Feiner, John Hughes, Morgan McGuire, David F. Sklar, Kurt Akeley 저자의 <a href="https://en.wikipedia.org/wiki/Computer_Graphics:_Principles_and_Practice">&lt;Computer Graphics Principles Practice></a>을 참고하여 작성함</p></div>